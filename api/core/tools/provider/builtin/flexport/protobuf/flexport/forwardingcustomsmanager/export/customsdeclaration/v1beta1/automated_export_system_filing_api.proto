// TEAM: kingsroad

syntax = "proto3";

package flexport.forwardingcustomsmanager.export.customsdeclaration.v1beta1;

import "flexport/forwardingcustomsmanager/export/customsdeclaration/enums/v1beta1/automated_export_system.proto";
import "flexport/forwardingcustomsmanager/export/customsdeclaration/enums/v1beta1/customs_broker.proto";
import "google/protobuf/timestamp.proto";
import "google/rpc/status.proto";

option java_multiple_files = true;
option java_outer_classname = "AutomatedExportSystemFilingApiProto";
option java_package = "com.flexport.forwardingcustomsmanager.export.customsdeclaration.v1beta1";
option ruby_package = "Flexport::ForwardingCustomsManager::ExportCustomsDeclaration::V1Beta1";

// Export.CustomsDeclaration.AutomatedExportSystemFiling
// US export system information
message AutomatedExportSystemFiling {
  string fid = 1;
  string shipment_fid = 2;
  optional string custom_aes_filing_id = 3; // legacy id from core

  string itn_number = 11; // internal transaction number
  enums.v1beta1.CustomsBroker customs_broker = 12;
  string broker_comment = 13;

  // 17: extend aes form information need
  optional TransmissionRecord last_transmission = 18;
  optional DifferenceRecord difference_since_last_submission = 19;

  enums.v1beta1.AesFilingStatus filing_status = 20;

  optional google.protobuf.Timestamp created_at = 21;
  optional string created_by_fid = 22;
  optional google.protobuf.Timestamp updated_at = 23;
  optional string updated_by_fid = 24;
}

// record the information for data transmitted to AES / AES broker
message TransmissionRecord {
  enums.v1beta1.CustomsBroker customs_broker = 1;
  enums.v1beta1.RequestMethod method = 2;
  string payload = 3; // request body

  optional string response_code = 4;
  repeated string error_messages = 5;

  google.protobuf.Timestamp transmitted_at = 11;
  string transmitted_by_fid = 12;
}

message DifferenceRecord {
  repeated DifferentField diff_fields = 1;
  google.protobuf.Timestamp diff_at = 2;

  repeated string dismissed_fields = 11;
  optional google.protobuf.Timestamp dismissed_at = 12;
  optional string dismissed_by_fid = 13;
}

message DifferentField {
  string field_name = 1;
  string previous_value = 2;
  string current_value = 3;
}

message UpsertForwardingCustomsAesFilingRequest {
  AutomatedExportSystemFiling aes_filing = 1;
}

message UpsertForwardingCustomsAesFilingResponse {
  google.rpc.Status status = 1;
}

service AutomatedExportSystemFilingAPI {
  // Create or update customs aes filing, allowed to be called either update an existing aes filing or create a new one from legacy Monorail.
  rpc UpsertForwardingCustomsAesFiling(UpsertForwardingCustomsAesFilingRequest) returns (UpsertForwardingCustomsAesFilingResponse);
}
